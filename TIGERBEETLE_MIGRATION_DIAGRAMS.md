# TigerBeetle Wallet Migration - Mermaid Diagrams Reference\n\n**Quick Reference for All Operation Flows**\n\nThis document contains all mermaid diagrams from the migration analysis for easy viewing and presentation.\n\n---\n\n## 1. GetBalance Operation\n\n### Current MongoDB Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as GetWalletBalanceQueryHandler\n    participant Repo as PaymentsWalletRepository\n    participant MongoDB\n\n    Client->>API: GET /balance/client123/USA/USD?issuerTypeIdentifier=VISA\n    API->>Handler: GetWalletBalanceQuery\n    Handler->>Repo: FindBy(client123, USA, USD, VISA)\n    Repo->>MongoDB: Find({ ClientId: \"client123\", Country.Code: \"USA\", Currency.Code: \"USD\", IssuerTypeIdentifier: \"VISA\" })\n    MongoDB-->>Repo: PaymentsWallet document\n    Repo-->>Handler: PaymentsWallet entity\n    Handler-->>API: WalletBalanceVm { Credit: 100, Debit: 0, HistoricalCredit: 150 }\n    API-->>Client: JSON Response\n```\n\n### Future TigerBeetle Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as GetWalletBalanceQueryHandler\n    participant Repo as TigerBeetleWalletRepository\n    participant TB as TigerBeetle\n    participant Cache as Redis/Memory Cache\n\n    Client->>API: GET /balance/client123/USA/USD?issuerTypeIdentifier=VISA\n    API->>Handler: GetWalletBalanceQuery\n    Handler->>Repo: GetBalance(client123, USA, USD, VISA)\n\n    alt Cache Hit\n        Repo->>Cache: Get cached balance\n        Cache-->>Repo: Cached account data\n    else Cache Miss\n        Repo->>Repo: accountId = Hash(client123+USA+USD+VISA)\n        Repo->>TB: lookup_accounts([accountId])\n        TB-->>Repo: Account { credits_posted: 250, debits_posted: 150 }\n        Repo->>Cache: Cache account data (TTL: 60s)\n    end\n\n    Repo->>Repo: Calculate: balance = credits_posted - debits_posted\n    Repo-->>Handler: Balance { Credit: 100, Debit: 0 }\n    Handler-->>API: WalletBalanceVm\n    API-->>Client: JSON Response\n```\n\n---\n\n## 2. GetMultiBalance Operation\n\n### Current MongoDB Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as GetMultiBalanceQueryHandler\n    participant Repo as PaymentsWalletRepository\n    participant MongoDB\n\n    Client->>API: GET /balances/client123\n    API->>Handler: GetMultiBalanceQuery { ClientId: \"client123\" }\n    Handler->>Repo: GetWalletsBy(\"client123\")\n    Repo->>MongoDB: Find({ ClientId: \"client123\" })\n    MongoDB-->>Repo: [PaymentsWallet, PaymentsWallet, ...]\n    Repo-->>Handler: List<PaymentsWallet> (3 wallets)\n    Handler->>Handler: Map to MultiBalanceVm\n    Handler-->>API: MultiBalanceVm { Balances: [3 items] }\n    API-->>Client: JSON Response\n```\n\n### Future TigerBeetle Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as GetMultiBalanceQueryHandler\n    participant Repo as TigerBeetleWalletRepository\n    participant Mapper as AccountIdMapper\n    participant TB as TigerBeetle\n    participant Cache as Redis Cache\n\n    Client->>API: GET /balances/client123\n    API->>Handler: GetMultiBalanceQuery { ClientId: \"client123\" }\n    Handler->>Repo: GetAllWalletsForClient(\"client123\")\n\n    Repo->>Mapper: GetAccountIdsForClient(\"client123\")\n    Mapper->>Mapper: Query client account registry\n    Note over Mapper: Registry stores: client123 → [accountId1, accountId2, accountId3]\n    Mapper-->>Repo: [accountId1, accountId2, accountId3]\n\n    alt Cache Hit (partial or full)\n        Repo->>Cache: Get cached accounts\n        Cache-->>Repo: Partial account data\n    end\n\n    Repo->>TB: lookup_accounts([accountId1, accountId2, accountId3])\n    TB-->>Repo: [Account, Account, Account]\n\n    Repo->>Cache: Cache all account data\n    Repo->>Repo: Calculate balances for each account\n    Repo-->>Handler: List<WalletBalance>\n    Handler-->>API: MultiBalanceVm\n    API-->>Client: JSON Response\n```\n\n---\n\n## 3. AddCredits Operation\n\n### Current MongoDB Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as AddCreditCommandHandler\n    participant WalletRepo as PaymentsWalletRepository\n    participant CountryRepo as PaymentsWalletCountryRepository\n    participant CurrencyRepo as PaymentsWalletCurrencyRepository\n    participant TxRepo as PaymentsWalletTransactionRepository\n    participant EventService as DomainEventService\n    participant MongoDB\n\n    Client->>API: POST /credit { amount: 50, clientId: \"client123\", country: \"USA\", currency: \"USD\" }\n    API->>Handler: AddCreditCommand\n\n    Handler->>WalletRepo: FindBy(client123, USA, USD, null)\n    WalletRepo->>MongoDB: Find wallet\n\n    alt Wallet Exists with Debt\n        MongoDB-->>WalletRepo: PaymentsWallet { Credit: 0, Debit: 30 }\n        WalletRepo-->>Handler: Existing wallet\n\n        Handler->>Handler: Calculate: 50 >= 30, so Credit = 20, Debit = 0\n        Handler->>Handler: OldBalance = \"-30\", NewBalance = \"20\"\n        Handler->>Handler: HistoricalCredit += 50\n\n    else Wallet Exists without Debt\n        MongoDB-->>WalletRepo: PaymentsWallet { Credit: 100, Debit: 0 }\n        WalletRepo-->>Handler: Existing wallet\n\n        Handler->>Handler: Credit = 100 + 50 = 150\n        Handler->>Handler: OldBalance = \"100\", NewBalance = \"150\"\n        Handler->>Handler: HistoricalCredit += 50\n\n    else Wallet Doesn't Exist\n        MongoDB-->>WalletRepo: null\n        WalletRepo-->>Handler: null\n\n        Handler->>CountryRepo: FindBy(\"USA\")\n        CountryRepo->>MongoDB: Find country metadata\n        MongoDB-->>CountryRepo: PaymentsWalletCountry\n        CountryRepo-->>Handler: Country\n\n        Handler->>CurrencyRepo: FindBy(\"USD\")\n        CurrencyRepo->>MongoDB: Find currency metadata\n        MongoDB-->>CurrencyRepo: PaymentsWalletCurrency\n        CurrencyRepo-->>Handler: Currency\n\n        Handler->>Handler: Create new wallet { Credit: 50, Debit: 0, HistoricalCredit: 50 }\n        Handler->>Handler: OldBalance = \"0\", NewBalance = \"50\"\n    end\n\n    Handler->>WalletRepo: UpsertAsync(wallet)\n    WalletRepo->>MongoDB: Update/Insert wallet\n    MongoDB-->>WalletRepo: Success\n\n    Handler->>Handler: Create transaction { Type: Credit, Amount: 50, OldBalance, NewBalance }\n    Handler->>TxRepo: UpsertAsync(transaction)\n    TxRepo->>MongoDB: Insert transaction\n    MongoDB-->>TxRepo: Success\n\n    Handler->>EventService: Publish(WalletTransactionCreated)\n    EventService-->>Handler: Event published\n\n    Handler-->>API: WalletBalanceVm { Credit: 150, Debit: 0, TransactionId: \"tx123\" }\n    API-->>Client: 200 OK\n```\n\n### Future TigerBeetle Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as AddCreditCommandHandler\n    participant Repo as TigerBeetleWalletRepository\n    participant Registry as AccountRegistry\n    participant TB as TigerBeetle\n    participant EventBus as MassTransit\n\n    Client->>API: POST /credit { amount: 50, clientId: \"client123\", country: \"USA\", currency: \"USD\" }\n    API->>Handler: AddCreditCommand\n\n    Handler->>Repo: AddCredit(client123, USA, USD, 50, null)\n    Repo->>Repo: accountId = Hash(client123+USA+USD+null)\n\n    Repo->>TB: lookup_accounts([accountId])\n\n    alt Account Exists\n        TB-->>Repo: Account { credits_posted: 15000, debits_posted: 18000 }\n        Note over Repo: Current balance = 150 - 180 = -30 (has $30 debt)\n\n        Repo->>Repo: Create transfer to add $50 credit\n        Note over Repo: Transfer: System Reserve Account → Customer Account\n\n        Repo->>TB: create_transfers([{<br/>  id: GenerateUUID(),<br/>  debit_account_id: SYSTEM_RESERVE_USD,<br/>  credit_account_id: accountId,<br/>  amount: 5000 (cents),<br/>  ledger: USD_LEDGER,<br/>  code: CREDIT_OPERATION,<br/>  user_data_128: Hash(referenceId)<br/>}])\n\n        TB->>TB: Atomic double-entry transfer\n        Note over TB: System Reserve: debits_posted += 5000<br/>Customer: credits_posted += 5000\n        TB-->>Repo: TransferResult { success }\n\n        Repo->>TB: lookup_accounts([accountId])\n        TB-->>Repo: Account { credits_posted: 20000, debits_posted: 18000 }\n        Note over Repo: New balance = 200 - 180 = +20\n\n    else Account Doesn't Exist\n        TB-->>Repo: Account not found\n\n        Repo->>TB: create_accounts([{<br/>  id: accountId,<br/>  ledger: USD_LEDGER,<br/>  code: CUSTOMER_WALLET,<br/>  user_data_128: Hash(clientId),<br/>  user_data_64: EncodeCountryIssuer(USA, null),<br/>  flags: DEBITS_MUST_NOT_EXCEED_CREDITS<br/>}])\n\n        TB-->>Repo: AccountResult { success }\n\n        Repo->>Registry: Register(clientId, accountId, USA, USD, null)\n        Registry-->>Repo: Success\n\n        Repo->>TB: create_transfers([{<br/>  debit_account_id: SYSTEM_RESERVE_USD,<br/>  credit_account_id: accountId,<br/>  amount: 5000<br/>}])\n\n        TB-->>Repo: TransferResult { success }\n    end\n\n    Repo->>Repo: Calculate Credit/Debit for response\n    Repo-->>Handler: WalletBalance { Credit: 20, Debit: 0, TransactionId }\n\n    Handler->>EventBus: Publish(WalletTransactionCreated)\n    EventBus-->>Handler: Event published\n\n    Handler-->>API: WalletBalanceVm\n    API-->>Client: 200 OK\n```\n\n---\n\n## 4. SubtractCredits (Debit) Operation\n\n### Current MongoDB Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as RemoveCreditsCommandHandler\n    participant Repo as PaymentsWalletRepository\n    participant TxRepo as PaymentsWalletTransactionRepository\n    participant EventService as DomainEventService\n    participant MongoDB\n\n    Client->>API: PUT /debit { amount: 75, clientId: \"client123\", country: \"USA\", currency: \"USD\", referenceId: \"pay_123\" }\n    API->>Handler: RemoveCreditsCommand\n\n    Handler->>Repo: FindBy(client123, USA, USD, null)\n    Repo->>MongoDB: Find wallet\n\n    alt Sufficient Credit\n        MongoDB-->>Repo: PaymentsWallet { Credit: 100, Debit: 0 }\n        Repo-->>Handler: Existing wallet\n\n        Handler->>Handler: Credit = 100 - 75 = 25\n        Handler->>Handler: OldBalance = \"100\", NewBalance = \"25\"\n\n    else Insufficient Credit (goes negative)\n        MongoDB-->>Repo: PaymentsWallet { Credit: 50, Debit: 0 }\n        Repo-->>Handler: Existing wallet\n\n        Handler->>Handler: Deficit = 75 - 50 = 25\n        Handler->>Handler: Credit = 0, Debit = 25\n        Handler->>Handler: OldBalance = \"50\", NewBalance = \"-25\"\n    end\n\n    Handler->>Handler: Create transaction { Type: Debit, Amount: 75, ReferenceId: \"pay_123\" }\n\n    Handler->>TxRepo: UpsertAsync(transaction)\n    TxRepo->>MongoDB: Insert transaction\n    Handler->>Repo: UpsertAsync(wallet)\n    Repo->>MongoDB: Update wallet\n\n    MongoDB-->>Repo: Success\n    MongoDB-->>TxRepo: Success\n\n    Handler->>EventService: Publish(WalletTransactionCreated)\n\n    Handler-->>API: WalletBalanceVm { Credit: 0, Debit: 25, TransactionId: \"tx456\" }\n    API-->>Client: 200 OK\n```\n\n### Future TigerBeetle Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as RemoveCreditsCommandHandler\n    participant Repo as TigerBeetleWalletRepository\n    participant TB as TigerBeetle\n    participant EventBus as MassTransit\n\n    Client->>API: PUT /debit { amount: 75, referenceId: \"pay_123\" }\n    API->>Handler: RemoveCreditsCommand\n\n    Handler->>Repo: SubtractCredit(client123, USA, USD, 75, \"pay_123\", null)\n    Repo->>Repo: accountId = Hash(client123+USA+USD+null)\n\n    Repo->>TB: lookup_accounts([accountId])\n    TB-->>Repo: Account { credits_posted: 10000, debits_posted: 5000 }\n    Note over Repo: Current balance = 100 - 50 = +50\n\n    alt Allow Negative Balances (Overdraft)\n        Note over Repo: Transfer: Customer Account → System Expense Account\n        Repo->>TB: create_transfers([{<br/>  id: GenerateUUID(),<br/>  debit_account_id: accountId,<br/>  credit_account_id: SYSTEM_EXPENSE_USD,<br/>  amount: 7500 (cents),<br/>  ledger: USD_LEDGER,<br/>  code: DEBIT_OPERATION,<br/>  user_data_128: Hash(\"pay_123\"),<br/>  flags: 0 (no restrictions)<br/>}])\n\n        TB->>TB: Atomic transfer\n        Note over TB: Customer: debits_posted += 7500<br/>System Expense: credits_posted += 7500\n        TB-->>Repo: TransferResult { success }\n\n        Repo->>TB: lookup_accounts([accountId])\n        TB-->>Repo: Account { credits_posted: 10000, debits_posted: 12500 }\n        Note over Repo: New balance = 100 - 125 = -25 (has $25 debt)\n\n    else Enforce Positive Balance Only\n        Note over Repo: Account has DEBITS_MUST_NOT_EXCEED_CREDITS flag\n        Repo->>TB: create_transfers([{ amount: 7500, ... }])\n        TB-->>Repo: TransferResult { error: exceeds_credits }\n        Repo-->>Handler: InsufficientFundsException\n        Handler-->>API: 400 Bad Request\n        API-->>Client: Error: Insufficient funds\n    end\n\n    alt Success Case\n        Repo->>Repo: Calculate Credit/Debit representation\n        Note over Repo: Credit = 0, Debit = 25\n        Repo-->>Handler: WalletBalance { Credit: 0, Debit: 25 }\n\n        Handler->>EventBus: Publish(WalletTransactionCreated)\n        Handler-->>API: WalletBalanceVm\n        API-->>Client: 200 OK\n    end\n```\n\n---\n\n## 5. VoidTransaction Operation\n\n### Current MongoDB Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as VoidTransactionCommandHandler\n    participant TxRepo as PaymentsWalletTransactionRepository\n    participant WalletRepo as PaymentsWalletRepository\n    participant EventService as DomainEventService\n    participant MongoDB\n\n    Client->>API: POST /void { transactionId: \"tx_abc123\" }\n    API->>Handler: VoidTransactionCommand\n\n    Handler->>TxRepo: GetAsync(\"tx_abc123\")\n    TxRepo->>MongoDB: Find transaction\n    MongoDB-->>TxRepo: PaymentsWalletTransaction { Type: Credit, Amount: 50, Wallet: {...} }\n    TxRepo-->>Handler: Original transaction\n\n    Handler->>WalletRepo: FindBy(clientId, country, currency, issuerIdentifier)\n    WalletRepo->>MongoDB: Find wallet\n    MongoDB-->>WalletRepo: PaymentsWallet { Credit: 150, Debit: 0, HistoricalCredit: 200 }\n    WalletRepo-->>Handler: Current wallet\n\n    Handler->>Handler: Calculate current balance: 150 - 0 = 150\n\n    alt Void Credit (Type = CreditVoid)\n        Handler->>Handler: balance = 150 - 50 = 100\n        Handler->>Handler: HistoricalCredit = 200 - 50 = 150\n\n        alt Balance >= 0\n            Handler->>Handler: Credit = 100, Debit = 0\n        else Balance < 0\n            Handler->>Handler: Credit = 0, Debit = 50\n        end\n\n    else Void Debit (Type = DebitVoid)\n        Handler->>Handler: balance = 150 + 50 = 200\n        Handler->>Handler: Credit = 200, Debit = 0\n    end\n\n    Handler->>Handler: Create void transaction {<br/>  Type: CreditVoid,<br/>  Amount: 50,<br/>  ReferenceTransactionId: \"tx_abc123\"<br/>}\n\n    Handler->>TxRepo: UpsertAsync(voidTransaction)\n    TxRepo->>MongoDB: Insert void transaction\n\n    Handler->>WalletRepo: UpsertAsync(wallet)\n    WalletRepo->>MongoDB: Update wallet\n\n    Handler->>Handler: Mark original as voided\n    Handler->>TxRepo: UpsertAsync(originalTx { Voided: true, UpdatedAt: now })\n    TxRepo->>MongoDB: Update original transaction\n\n    MongoDB-->>TxRepo: Success (3 writes)\n\n    Handler->>EventService: Publish(WalletTransactionCreated)\n\n    Handler-->>API: WalletBalanceVm { Credit: 100, Debit: 0, TransactionType: CreditVoid }\n    API-->>Client: 200 OK\n```\n\n### Future TigerBeetle Flow\n```mermaid\nsequenceDiagram\n    participant Client\n    participant API as WalletsController\n    participant Handler as VoidTransactionCommandHandler\n    participant Repo as TigerBeetleWalletRepository\n    participant TxRegistry as TransferRegistry (MongoDB)\n    participant TB as TigerBeetle\n    participant EventBus as MassTransit\n\n    Client->>API: POST /void { transactionId: \"tx_abc123\" }\n    API->>Handler: VoidTransactionCommand\n\n    Handler->>Repo: VoidTransaction(\"tx_abc123\")\n\n    Repo->>TxRegistry: GetTransferMetadata(\"tx_abc123\")\n    TxRegistry->>TxRegistry: Query MongoDB for transfer metadata\n    TxRegistry-->>Repo: TransferMetadata {<br/>  TigerBeetleTransferId: 0x123...,<br/>  Type: Credit,<br/>  Amount: 5000,<br/>  AccountId: 0xabc...,<br/>  Voided: false<br/>}\n\n    alt Transfer Already Voided\n        TxRegistry-->>Repo: TransferMetadata { Voided: true }\n        Repo-->>Handler: AlreadyVoidedException\n        Handler-->>API: 400 Bad Request\n        API-->>Client: Error: Transaction already voided\n    end\n\n    Repo->>TB: lookup_accounts([accountId])\n    TB-->>Repo: Account { credits_posted: 20000, debits_posted: 5000 }\n    Note over Repo: Current balance = 200 - 50 = +150\n\n    alt Void Credit (Reverse: Customer → System Reserve)\n        Repo->>TB: create_transfers([{<br/>  id: GenerateUUID(),<br/>  debit_account_id: accountId,<br/>  credit_account_id: SYSTEM_RESERVE_USD,<br/>  amount: 5000,<br/>  ledger: USD_LEDGER,<br/>  code: CREDIT_VOID,<br/>  user_data_128: Hash(\"tx_abc123\"),<br/>  user_data_64: originalTransferId<br/>}])\n\n        TB->>TB: Atomic void transfer\n        Note over TB: Customer: debits_posted += 5000<br/>System Reserve: credits_posted += 5000\n        TB-->>Repo: TransferResult { success }\n        Note over Repo: New balance = 200 - 100 = +100<br/>HistoricalCredit decreased by $50\n\n    else Void Debit (Reverse: System Expense → Customer)\n        Repo->>TB: create_transfers([{<br/>  debit_account_id: SYSTEM_EXPENSE_USD,<br/>  credit_account_id: accountId,<br/>  amount: 5000,<br/>  code: DEBIT_VOID,<br/>  user_data_128: Hash(\"tx_abc123\")<br/>}])\n\n        TB-->>Repo: TransferResult { success }\n        Note over Repo: New balance = 150 + 50 = +200\n    end\n\n    Repo->>TB: lookup_accounts([accountId])\n    TB-->>Repo: Account { credits_posted: 20000, debits_posted: 10000 }\n\n    Repo->>TxRegistry: MarkTransferAsVoided(\"tx_abc123\", voidTransferId)\n    TxRegistry->>TxRegistry: Update { Voided: true, VoidedAt: now, VoidTransferId: ... }\n    TxRegistry-->>Repo: Success\n\n    Repo->>Repo: Calculate new Credit/Debit\n    Repo-->>Handler: WalletBalance { Credit: 100, Debit: 0 }\n\n    Handler->>EventBus: Publish(WalletTransactionCreated)\n    Handler-->>API: WalletBalanceVm\n    API-->>Client: 200 OK\n```\n\n---\n\n## Migration Strategy Diagrams\n\n### Phase 1: Dual-Write Architecture\n```mermaid\ngraph LR\n    A[API Request] --> B[Application Layer]\n    B --> C[Wallet Repository]\n    C --> D[MongoDB Write]\n    C --> E[TigerBeetle Write]\n    C --> F[Read from MongoDB]\n    F --> G[Response]\n\n    E -.->|Async validation| H[Reconciliation Worker]\n    D -.->|Async validation| H\n    H --> I[Alert if mismatch]\n```\n\n### Phase 2: Shadow Read Architecture\n```mermaid\ngraph LR\n    A[API Request] --> B[Application Layer]\n    B --> C[Wallet Repository]\n    C --> D[MongoDB Read - PRIMARY]\n    C -.->|Shadow read| E[TigerBeetle Read]\n    D --> F[Response]\n    E -.->|Async comparison| G[Metrics Logger]\n    D -.->|Async comparison| G\n    G --> H[Datadog/CloudWatch]\n```\n\n### Phase 3: Gradual Read Cutover\n```mermaid\ngraph LR\n    A[API Request] --> B[Application Layer]\n    B --> C[Feature Flag Check]\n    C -->|10% traffic| D[TigerBeetle Read]\n    C -->|90% traffic| E[MongoDB Read]\n    D --> F[Response]\n    E --> F\n\n    D -.->|Fallback on error| E\n```\n\n---\n\n## Double-Entry Accounting Flows\n\n### Add Credit Flow\n```\nSystem Reserve Account (Debit)     -$50\nCustomer Wallet (Credit)           +$50\n────────────────────────────────────────\nNet Balance Change:                  $0\n```\n\n### Subtract Credit (Debit) Flow\n```\nCustomer Wallet (Debit)            -$30\nSystem Expense Account (Credit)    +$30\n────────────────────────────────────────\nNet Balance Change:                  $0\n```\n\n### Void Credit Flow\n```\nCustomer Wallet (Debit)            -$50\nSystem Reserve Account (Credit)    +$50\n────────────────────────────────────────\nNet Balance Change:                  $0\n```\n\n### Void Debit Flow\n```\nSystem Expense Account (Debit)     -$30\nCustomer Wallet (Credit)           +$30\n────────────────────────────────────────\nNet Balance Change:                  $0\n```\n\n---\n\n## Account Structure Diagram\n\n```mermaid\ngraph TB\n    subgraph \"USD Ledger (Ledger ID: 1)\"\n        SR[System Reserve Account - Code 2000]\n        SE[System Expense Account - Code 3000]\n        C1[Customer Wallet 1 - Hash client123+USA+USD]\n        C2[Customer Wallet 2 - Hash client456+USA+USD]\n    end\n\n    subgraph \"MXN Ledger (Ledger ID: 3)\"\n        SR2[System Reserve Account - Code 2000]\n        SE2[System Expense Account - Code 3000]\n        C3[Customer Wallet 3 - Hash client123+MEX+MXN]\n    end\n\n    SR -->|Add Credit Transfer| C1\n    C1 -->|Debit Transfer| SE\n    SR -->|Void Credit Transfer| C1\n    SE -->|Void Debit Transfer| C1\n\n    style SR fill:#90EE90\n    style SR2 fill:#90EE90\n    style SE fill:#FFB6C1\n    style SE2 fill:#FFB6C1\n    style C1 fill:#87CEEB\n    style C2 fill:#87CEEB\n    style C3 fill:#87CEEB\n```\n\n**Account Details:**\n\n**System Reserve Account (Code 2000):**\n- Credits: 0\n- Debits: Posted credits given to customers\n\n**System Expense Account (Code 3000):**\n- Credits: Posted debits from customers\n- Debits: 0\n\n**Customer Wallets (Code 1000):**\n- Credits Posted: Total amount added\n- Debits Posted: Total amount spent\n- ID: SHA-256 hash of composite key\n\n---\n\n## Data Mapping Diagram\n\n```mermaid\ngraph LR\n    subgraph \"MongoDB PaymentsWallet\"\n        M1[ClientId: client123]\n        M2[Country: USA]\n        M3[Currency: USD]\n        M4[IssuerTypeIdentifier: VISA]\n        M5[Credit: 100.00]\n        M6[Debit: 0.00]\n        M7[HistoricalCredit: 250.00]\n    end\n\n    subgraph \"TigerBeetle Account\"\n        T1[id: UInt128 Hash]\n        T2[ledger: 1 - USD Ledger]\n        T3[code: 1000 - Customer Wallet]\n        T4[user_data_128: Hash-clientId-]\n        T5[user_data_64: Encode-Country+Issuer-]\n        T6[credits_posted: 25000]\n        T7[debits_posted: 15000]\n    end\n\n    subgraph \"Account Registry MongoDB\"\n        R1[ClientId: client123]\n        R2[TigerBeetleAccountId: UInt128]\n        R3[CountryCode: USA]\n        R4[CurrencyCode: USD]\n        R5[IssuerTypeIdentifier: VISA]\n    end\n\n    M1 --> T4\n    M2 --> T5\n    M3 --> T2\n    M4 --> T5\n    M5 --> T6\n    M5 --> T7\n    M6 --> T6\n    M6 --> T7\n    M7 --> T6\n\n    M1 --> R1\n    T1 --> R2\n    M2 --> R3\n    M3 --> R4\n    M4 --> R5\n\n    style M5 fill:#FFE4B5\n    style M6 fill:#FFE4B5\n    style T6 fill:#98FB98\n    style T7 fill:#98FB98\n```\n\n**Calculation:**\n- MongoDB Balance: `Credit - Debit = 100 - 0 = $100`\n- TigerBeetle Balance: `(credits_posted - debits_posted) / 100 = (25000 - 15000) / 100 = $100`\n- MongoDB HistoricalCredit: `250.00`\n- TigerBeetle HistoricalCredit: `credits_posted / 100 = 25000 / 100 = $250`\n\n---\n\n**Document Version:** 1.0\n**Last Updated:** 2025-11-18\n**Related:** TIGERBEETLE_WALLET_MIGRATION.md"